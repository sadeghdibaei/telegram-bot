# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
# â”ƒ         CDN Handler for Userbot         â”ƒ
# â”ƒ   Handles fallback media via @urluploadxbot â”ƒ
# â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

import re
from pyrogram import Client
from pyrogram.types import Message

# ğŸ“¦ Shared upload state (imported from main file)
upload_state = {}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“¥ MAIN HANDLER FUNCTION
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def handle_cdn_link(client: Client, message: Message):
    chat_id = message.chat.id

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ” STEP 1: Detect CDN link in inline buttons
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if message.reply_markup:
        for row in message.reply_markup.inline_keyboard:
            for btn in row:
                if btn.url and "cdninstagram.com" in btn.url:
                    cdn_link = btn.url

                    # ğŸ§¹ Remove previous "Processing..." message
                    processing_msg_id = upload_state.get(chat_id, {}).get("processing_msg_id")
                    if processing_msg_id:
                        await client.delete_messages(chat_id, processing_msg_id)

                    # â³ Notify about large post
                    cdn_notice = await client.send_message(
                        chat_id,
                        "â³ Large post detected. Processing via alternate CDN route..."
                    )

                    # ğŸ§  Save state
                    upload_state[chat_id] = {
                        "step": "waiting",
                        "cdn_notice_id": cdn_notice.id
                    }

                    # ğŸ“¤ Send CDN link to @urluploadxbot
                    await client.send_message("urluploadxbot", cdn_link)
                    print(f"ğŸ“¤ Sent CDN link to @urluploadxbot")
                    return

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ–±ï¸ STEP 2: Auto-click "Default" button if rename prompt appears
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if message.text and "rename" in message.text.lower() and message.reply_markup:
        for row in message.reply_markup.inline_keyboard:
            for i, btn in enumerate(row):
                if "default" in btn.text.lower():
                    await message.click(i)
                    print(f"âœ… Clicked 'Default' button: {btn.text}")
                    for group_id in upload_state:
                        upload_state[group_id]["step"] = "processing"
                    return

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ¬ STEP 3: Final video received
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if message.video and chat_id in upload_state:
        print("ğŸ“¥ Final video received from @urluploadxbot")

        # ğŸ§¹ Remove temporary messages
        cdn_notice_id = upload_state[chat_id].get("cdn_notice_id")
        if cdn_notice_id:
            await client.delete_messages(chat_id, cdn_notice_id)

        processing_msg_id = upload_state[chat_id].get("processing_msg_id")
        if processing_msg_id:
            await client.delete_messages(chat_id, processing_msg_id)

        # âœ… Return video file ID for final delivery
        upload_state.pop(chat_id, None)
        return message.video.file_id

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # â­ STEP 4: Skip irrelevant messages
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if message.photo or "Û´ Ø¯Ù‚ÛŒÙ‚Ù‡" in message.text:
        print("â­ Skipped non-video message from @urluploadxbot")
        return

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # âŒ STEP 5: Fallback failure
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    cdn_notice_id = upload_state.get(chat_id, {}).get("cdn_notice_id")
    if cdn_notice_id:
        await client.delete_messages(chat_id, cdn_notice_id)

    processing_msg_id = upload_state.get(chat_id, {}).get("processing_msg_id")
    if processing_msg_id:
        await client.delete_messages(chat_id, processing_msg_id)

    await client.send_message(chat_id, "âŒ Failed to process the post. Please try again.")
    upload_state.pop(chat_id, None)
